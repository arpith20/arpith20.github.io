<!DOCTYPE html>
<html>    
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Introduction to insertOnEdge in Soot -- Arpith K </title>
  <meta name="description" content="This document explains the usage of `insertOnEdge` API available in Soot patchingChain.">
  <meta name="author" content="Arpith K">

  <link rel="stylesheet" href="http://arpith.xyz/css/main.css" | prepend: site.baseurl }}">
  <link rel="canonical" href="http://arpith.xyz/2016/05/insertonedge-soot/">
  <link rel="alternate" type="application/atom+xml" title="Arpith K" href="http://arpith.xyz/feed.xml" | prepend: site.baseurl | prepend: site.url }}" />
  <script src="http://arpith.xyz/scripts/jquery-1.11.2.min.js"></script>
  <script src="http://arpith.xyz/scripts/pithy.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css">

  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  	
</head>


  <body>
    <header class="header">
	<div class="header-container">
		<div class="nav">
			
			
				<li>
					<a href="http://arpith.xyz">home</a>
				</li>			
			
			
				<li>
					<a href="http://arpith.xyz/blog/">blog</a>
				</li>			
			
			
				<li>
					<a href="http://arpith.xyz/archive/">archive</a>
				</li>			
			
			
				<li>
					<a href="http://arpith.xyz/tags/">tags</a>
				</li>			
			
		</div>
		<div class="description"> A scrapbook full of random scripts </div>		
		<ul class="social-links">
			<li>
				<a href="https://github.com/arpith20" title="Github" target="_blank">
					<i class="fa fa fa-github fa-2x"></i>
				</a>
			</li>
			<li>
				<a href="https://twitter.com/_arpith" title="Twitter" target="_blank">
					<i class="fa fa-twitter fa-2x"></i>
				</a>
			</li>
			<li>
				<a href="https://www.goodreads.com/arpith" title="Goodreads" target="_blank">
					<i class="fa fa-book fa-2x"></i>
				</a>
			</li>
			<li>
				<a href="/feed.xml" title="RSS">
					<i class="fa fa-rss fa-2x"></i>
				</a>
			</li>
			
			
		</ul>		
	</div>
</header>

    <br>
    <div class="page-content">
      <div class="wrapper">
        <div class="post">
  <br>
  <header class="post-header">
    <h1 class="post-title">Introduction to insertOnEdge in Soot</h1>
    <p class="post-meta">May 7, 2016 • Arpith K</p>
  </header>

  <article class="post-content">
    <h2 id="table-of-contents">Table Of Contents</h2>

<ul id="markdown-toc">
  <li><a href="#table-of-contents" id="markdown-toc-table-of-contents">Table Of Contents</a></li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a>    <ul>
      <li><a href="#specified-by" id="markdown-toc-specified-by">Specified by</a></li>
      <li><a href="#parameters" id="markdown-toc-parameters">Parameters</a></li>
    </ul>
  </li>
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#usage" id="markdown-toc-usage">Usage</a></li>
  <li><a href="#code" id="markdown-toc-code">Code</a></li>
  <li><a href="#future-work" id="markdown-toc-future-work">Future Work</a></li>
</ul>

<hr />
<p><br /></p>

<h2 id="summary">Summary</h2>
<p><code class="highlighter-rouge">insertOnEdge</code> adds instrumentation(s) to the Chain in a manner such that the resulting <a href="https://en.wikipedia.org/wiki/Control_flow_graph">CFG</a> of the program will contain <code class="highlighter-rouge">toInsert</code> on an edge that is defined by <code class="highlighter-rouge">point_source</code> and <code class="highlighter-rouge">point_target</code>.</p>

<p>This API available in Soot’s <br />
<a href="https://ssebuild.cased.de/nightly/soot/javadoc/index.html?soot/PatchingChain.html" target="_blank">
<code class="highlighter-rouge">
Class patchingChain &lt;E extends Unit&gt; 
</code>
</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertOnEdge</span><span class="p">(</span><span class="n">E</span> <span class="n">toInsert</span><span class="o">,</span> <span class="n">E</span> <span class="n">point_src</span><span class="o">,</span> <span class="n">E</span> <span class="n">point_tgt</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertOnEdge</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">toInsert</span><span class="o">,</span> <span class="n">E</span> <span class="n">point_src</span><span class="o">,</span> <span class="n">E</span> <span class="n">point_tgt</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertOnEdge</span><span class="p">(</span><span class="n">Chain</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">toInsert</span><span class="o">,</span> <span class="n">E</span> <span class="n">point_src</span><span class="o">,</span> <span class="n">E</span> <span class="n">point_tgt</span><span class="o">)</span>
</code></pre>
</div>

<h3 id="specified-by">Specified by</h3>
<p><code class="highlighter-rouge">insertOnEdge</code> in interface <code class="highlighter-rouge">Chain&lt;E extends Unit&gt;</code></p>

<h3 id="parameters">Parameters</h3>
<ul>
  <li><code class="highlighter-rouge">toInsert </code> - the instrumentation to be added in the Chain</li>
  <li><code class="highlighter-rouge">point_src</code> - the source point of an edge in CFG</li>
  <li><code class="highlighter-rouge">point_tgt</code> - the target point of an edge in CFG</li>
</ul>

<hr />
<p><br /></p>

<h2 id="introduction">Introduction</h2>

<p>The <code class="highlighter-rouge">insertOnEdge</code> API correctly adds instructions (<code class="highlighter-rouge">toInsert</code>) to the target program (<code class="highlighter-rouge">Body</code>) on an edge. In a Control Flow Graph, such a directed edge would be represented by a source point (<code class="highlighter-rouge">point_src</code>) and a target unit (<code class="highlighter-rouge">point_tgt</code>).</p>

<p>Without this API, instrumenting certain edges can prove difficult and time consuming to the user.</p>

<p>Consider the following if condition:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">!=</span><span class="mi">40</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">//unit1</span>
  <span class="n">x</span><span class="o">=</span><span class="mi">40</span><span class="o">;</span>		<span class="c1">//unit2</span>
<span class="o">}</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="o">;</span>	<span class="c1">//unit3</span>
</code></pre>
</div>
<p>The control flow graph for the above code is as follows: <br />
<a href="/assets/soot/cfg.jpg"><img src="/assets/soot/cfg.jpg" alt="CFG" /></a></p>

<p>Assume that the user wishes to instrument all three edges with a statement <code class="highlighter-rouge">toInsert</code>.</p>

<ul>
  <li>
    <p>Edge 1: Can be instrumented using <code class="highlighter-rouge">body.getUnits().insertAfter(toInsert, Unit1)</code></p>
  </li>
  <li>
    <p>Edge 2: Can be instrumented using <code class="highlighter-rouge">body.getUnits().insertBeforeNoRedirect(toInsert, Unit3)</code></p>
  </li>
  <li>
    <p>Edge 3: ????</p>
  </li>
</ul>

<p>None of the APIs previously available enables a user to easily instrument <em>only</em> the false branch (Edge 3). Neither <code class="highlighter-rouge">insertBefore unit3</code> nor <code class="highlighter-rouge">insertAfter unit1</code> will work. Using <code class="highlighter-rouge">insertBefore unit3</code> will cause the instrumentation to be executed no matter which branch the program takes.</p>

<p>This is where insertOnEdge comes in. The 3rd edge can be instrumented by simply using <a href="/assets/soot/easy.jpg" target="_blank"><code class="highlighter-rouge">body.getUnits().insertOnEdge(toInsert, Unit1, Unit3);</code></a></p>

<p>In fact, insertOnEdge can be used on all three edges. This further reduces the user’s work.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">body</span><span class="o">.</span><span class="na">getUnits</span><span class="o">().</span><span class="na">insertOnEdge</span><span class="o">(</span><span class="n">toInsert</span><span class="o">,</span> <span class="n">Unit1</span><span class="o">,</span> <span class="n">Unit2</span><span class="o">);</span>
<span class="n">body</span><span class="o">.</span><span class="na">getUnits</span><span class="o">().</span><span class="na">insertOnEdge</span><span class="o">(</span><span class="n">toInsert</span><span class="o">,</span> <span class="n">Unit2</span><span class="o">,</span> <span class="n">Unit3</span><span class="o">);</span>
<span class="n">body</span><span class="o">.</span><span class="na">getUnits</span><span class="o">().</span><span class="na">insertOnEdge</span><span class="o">(</span><span class="n">toInsert</span><span class="o">,</span> <span class="n">Unit1</span><span class="o">,</span> <span class="n">Unit3</span><span class="o">);</span>
</code></pre>
</div>

<hr />
<p><br /></p>

<h2 id="usage">Usage</h2>
<ul>
  <li>
    <p><code class="highlighter-rouge">insertOnEdge(toInsert, null, target)</code> <br />
Doing this is same as performing <code class="highlighter-rouge">insertBefore(toInsert, target)</code>. All jumps to <code class="highlighter-rouge">target</code> is redirected to <code class="highlighter-rouge">toInsert</code></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">insertOnEdge(toInsert, source, null)</code> <br />
Doing this is same as performing <code class="highlighter-rouge">insertAfter(toInsert, source)</code></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">insertOnEdge(toInsert, source, target)</code> <br />
This adds an instrumentation in a manner such that the resulting CFG of the program will contain <code class="highlighter-rouge">toInsert</code> on an edge that is defined by <code class="highlighter-rouge">source</code> and <code class="highlighter-rouge">target</code>. <br />
<code class="highlighter-rouge">insertOnEdge</code> will throw RuntimeException if such an edge does not exist in the program’s CFG.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">insertOnEdge(toInsert, null, null)</code> <br />
Just don’t do this. <code class="highlighter-rouge">insertOnEdge</code> will throw a RuntimeException<a href="/assets/soot/ohshi.jpg" target="_blank">.</a></p>
  </li>
</ul>

<hr />
<p><br /></p>

<h2 id="code">Code</h2>
<p>You could read the following code to go into the nitty-gritties of insertOnEdge. <a href="https://gist.github.com/arpith20/d4ccb3476e71a2e2bedd1258c6a5c3f6#file-insertonedge-java"><em>(View code on GitHub)</em></a>:</p>

<script width="110%" src="https://gist.github.com/arpith20/d4ccb3476e71a2e2bedd1258c6a5c3f6.js"></script>

<hr />
<p><br /></p>

<h2 id="future-work">Future Work</h2>
<ul>
  <li>At the time of writing, this work is tested and known to work on Jimple code. Shimple  intermediate representation is not supported.</li>
  <li>Exception edges cannot be instrumented using this method.</li>
</ul>

<p>If you have implemented any of these features, you could consider <a href="https://github.com/Sable/soot/wiki/Contributing-to-Soot" target="_blank">contributing to soot</a>.</p>

<hr />

<p><br />
PS: The insertOnEdge feature was added to the Soot repository with this pull request: <a href="https://github.com/Sable/soot/pull/583" target="_blank">Feature/insert on edge #583</a></p>

<p>Have any suggestions or questions that you want answered? Feel free to contact me or use the comment section below.</p>

  </article>


	<hr/>
	<br/>
	<h2> Comments </h2>
	<div id="disqus_thread"></div>
	<script>
	/**
	* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
	*/
	/*
	var disqus_config = function () {
	this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
	this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};
	*/
	(function() { // DON'T EDIT BELOW THIS LINE
	var d = document, s = d.createElement('script');

	s.src = '//arpith.disqus.com/embed.js';

	s.setAttribute('data-timestamp', +new Date());
	(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>

      </div>
    </div>
    
    <footer class="footer">
  <div id="gotop">^</div>
  <br>
	@2016 Arpith K<br/>
	Hosted on GitHub<br/>
	   &nbsp;
</footer>

    
  </body>

</html>
