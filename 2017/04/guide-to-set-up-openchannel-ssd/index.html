<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <title>Guide to Setup an OpenChannel SSD using QEMU -- Arpith K </title> <meta name="description" content="Instructions to set up and get started with OpenChannel SSDs"> <meta name="author" content="Arpith K"> <meta name="twitter:card" content="summary"/> <meta name="twitter:site" content="@_arpith"/> <meta name="twitter:creator" content="@_arpith"/> <meta property="og:title" content="Guide to Setup an OpenChannel SSD using QEMU"> <meta property="og:description" content="Instructions to set up and get started with OpenChannel SSDs"> <meta property="og:url" content="https://arpith.xyz/2017/04/guide-to-set-up-openchannel-ssd/"> <meta property="fb:app_id" content="1289467297738605"> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="https://arpith.xyz/2017/04/guide-to-set-up-openchannel-ssd/"> <link rel="alternate" type="application/atom+xml" title="Arpith K" href="https://arpith.xyz/feed.xml"/> <script src="/scripts/jquery-1.11.2.min.js"></script> <script src="/scripts/pithy.js"></script> <script src="/scripts/konami.js"></script> <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css"> <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"> <script>!function(a,n,e,y,N,t,c){a.GoogleAnalyticsObject=N,a[N]=a[N]||function(){(a[N].q=a[N].q||[]).push(arguments)},a[N].l=1*new Date,t=n.createElement(e),c=n.getElementsByTagName(e)[0],t.async=1,t.src=y,c.parentNode.insertBefore(t,c)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-77896043-1","auto"),ga("require","linkid"),ga("send","pageview");var easter_egg=new Konami("/NyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyanNyan/");</script> </head> <body> <header class="header"> <div class="header-container"> <div class="nav"> <li> <a href="/">home</a> </li> <li> <a href="/notes/">blog</a> </li> <li> <a href="/archive/">archive</a> </li> <li> <a href="/tag/">tags</a> </li> <li> <a href="/projects/">projects</a> </li> <li> <a href="/books/">books</a> </li> </div> <div class="description"> A scrapbook full of random scripts </div> <ul class="social-links"> <li> <a href="https://github.com/arpith20" title="Github" target="_blank"> <i class="fa fa fa-github fa-2x"></i> </a> </li> <li> <a href="https://twitter.com/_arpith" title="Twitter" target="_blank"> <i class="fa fa-twitter fa-2x"></i> </a> </li> <li> <a href="/books/" title="Goodreads"> <i class="fa fa-book fa-2x"></i> </a> </li> <li> <a href="/feed.xml" title="RSS"> <i class="fa fa-rss fa-2x"></i> </a> </li> </ul> </div> </header> <br> <div class="page-content"> <div class="wrapper"> <div class="post"> <br> <header class="post-header"> <h1 class="post-title">Guide to Setup an OpenChannel SSD using QEMU</h1> <p class="post-meta">Apr 18, 2017 • Arpith K</p> </header> <article class="post-content"> <p><br/></p> <h2>Table Of Contents</h2> <ul id="markdown-toc"> <li><a href="#download-linux-kernel-and-compile-it" id="markdown-toc-download-linux-kernel-and-compile-it">Download Linux Kernel and Compile it</a></li> <li><a href="#install-and-setup-qemu" id="markdown-toc-install-and-setup-qemu">Install and Setup QEMU</a></li> <li><a href="#compile-and-install-nvme-cli-liblightnvm-and-pblk-tools" id="markdown-toc-compile-and-install-nvme-cli-liblightnvm-and-pblk-tools">Compile and Install NVMe CLI, liblightnvm and pblk-tools</a></li> </ul> <p>This blog post describes the steps that I took to set up an environment with OpenChannel SSD using QEMU.</p> <h2 id="download-linux-kernel-and-compile-it">Download Linux Kernel and Compile it</h2> <p>The first step is to download the Linux kernel source from OpenChannelSSD’s GitHub repository. At the time of writing, features like <i>pblk</i> were not available on mainline Linux kernel. Compiling your own kernel might not be necessary in the future.</p> <ul> <li>Change to the directory where you want to clone the git repository. In this example I will use <code class="highlighter-rouge">/home/arpith/part/linux</code></li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$cd</span> /home/arpith/part/linux</code></pre></figure> <ul> <li>Clone the kernel: <br/> At the time of writing this, latest kernel was available in the <code class="highlighter-rouge">for-next</code> branch of <a href="https://github.com/OpenChannelSSD/linux">https://github.com/OpenChannelSSD/linux</a></li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$git</span> clone <span class="nt">-b</span> <span class="k">for</span><span class="nt">-next</span> git@github.com:OpenChannelSSD/linux.git</code></pre></figure> <ul> <li>Copy the kernel config file from your existing system to the kernel tree:</li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$cp</span> /boot/config-<span class="sb">`</span><span class="nb">uname</span> <span class="nt">-r</span><span class="sb">`</span> .config</code></pre></figure> <ul> <li>Make sure that the .config file includes the following:</li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">CONFIG_NVM</span><span class="o">=</span>y
<span class="c"># Expose the /sys/module/lnvm/parameters/configure_debug interface</span>
<span class="nv">CONFIG_NVM_DEBUG</span><span class="o">=</span>y
<span class="c"># Target support (required to expose the open-channel SSD as a block device)</span>
<span class="nv">CONFIG_NVM_PBLK</span><span class="o">=</span>y
<span class="c"># For NVMe support</span>
<span class="nv">CONFIG_BLK_DEV_NVME</span><span class="o">=</span>y</code></pre></figure> <ul> <li>Bring the config file up to date. Answer any questions that get prompted. Unless you know you are interested in a particular feature, accepting the default option by pressing Enter should be a safe choice:</li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$make</span> oldconfig</code></pre></figure> <ul> <li>Clean the kernel source directory:</li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$make</span> clean</code></pre></figure> <ul> <li>Build the linux-image and linux-header .deb files using a thread per core + 1.</li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$make</span> <span class="nt">-j</span> <span class="sb">`</span>getconf _NPROCESSORS_ONLN<span class="sb">`</span> deb-pkg <span class="nv">LOCALVERSION</span><span class="o">=</span><span class="nt">-custom</span></code></pre></figure> <p>This creates <code class="highlighter-rouge">.deb</code> files which is used to install the kernel in QEMU.</p> <h2 id="install-and-setup-qemu">Install and Setup QEMU</h2> <p>In case you don’t have a physical OpenChannel SSD in hand, you may use Keith Busch’s QEMU branch to emulate the device via a backend file.</p> <ul> <li>Create an empty file to hold your NVMe device.</li> </ul> <figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$dd</span> <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>blknvme <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>1024</code></pre></figure> <ul> <li>Clone, compile and install QEMU <br/> You might need to install the following depencencies. <br/> <code class="highlighter-rouge">sudo apt install libpixman-1-dev libaio-dev libspice-server-dev libspice-protocol-dev libattr1-dev libcap-dev </code></li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$git</span> clone git@github.com:OpenChannelSSD/qemu-nvme.git
<span class="nv">$.</span>/configure <span class="nt">--python</span><span class="o">=</span>/usr/bin/python2 <span class="nt">--enable-kvm</span> <span class="se">\</span>
<span class="nt">--target-list</span><span class="o">=</span>x86_64-softmmu <span class="nt">--enable-linux-aio</span> <span class="se">\</span>
<span class="nt">--prefix</span><span class="o">=</span><span class="nv">$HOME</span>/qemu-nvme <span class="nt">--enable-virtfs</span> <span class="nt">--disable-werror</span> <span class="nt">--enable-spice</span>
<span class="nv">$make</span> <span class="nt">-j8</span>
<span class="nv">$make</span> <span class="nb">install</span>
<span class="nv">$cd</span> <span class="nv">$HOME</span>/qemu-nvme/bin</code></pre></figure> <ul> <li>Download Ubuntu and install it in QEMU. Start by creating a disk image and booting Ubuntu from an ISO.</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$qemu</span><span class="nt">-img</span> create ubuntu.img 30G
<span class="nv">$qemu</span><span class="nt">-system-x86_64</span> <span class="nt">-hda</span> ./ubuntu.img <span class="nt">-boot</span> d <span class="se">\</span>
<span class="nt">-cdrom</span> ./ubuntu-17.04-beta2-desktop-amd64.iso <span class="nt">--enable-kvm</span> <span class="nt">-m</span> 16G <span class="nt">-smp</span> 12</code></pre></figure> <p>For more information on what the parameters do, visit <a href="https://smdaudhilbe.wordpress.com/2013/04/11/how-to-install-ubuntu-inside-qemu-emulator-and-make-a-virtual-machine/" target="_blank">smdaudhilbe.wordpress.com</a></p> <ul> <li> <p>Follow the on-screen instructions to install Ubuntu</p> </li> <li> <p>After installation, start the VM with the following parameters. You may notice that I am using <a href="https://www.spice-space.org/index.html" target="_blank">spice</a>.</p> </li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$qemu</span><span class="nt">-system-x86_64</span> <span class="nt">-hda</span> ./ubuntu.img <span class="nt">--enable-kvm</span> <span class="nt">-m</span> 16G <span class="nt">-smp</span> 12 <span class="se">\</span>
<span class="nt">-virtfs</span> <span class="nb">local</span>,path<span class="o">=</span>/home/arpith/part,mount_tag<span class="o">=</span>host0,security_model<span class="o">=</span>none,id<span class="o">=</span>host0 <span class="se">\</span>
<span class="nt">-drive</span> <span class="nv">file</span><span class="o">=</span>./blknvme,if<span class="o">=</span>none,id<span class="o">=</span>mynvme <span class="se">\</span>
<span class="nt">-device</span> nvme,drive<span class="o">=</span>mynvme,serial<span class="o">=</span>deadbeef,namespaces<span class="o">=</span>1,lver<span class="o">=</span>1,lmetasize<span class="o">=</span>16,ll2pmode<span class="o">=</span>0,nlbaf<span class="o">=</span>5,lba_index<span class="o">=</span>3,mdts<span class="o">=</span>10,<span class="se">\</span>
<span class="nv">lnum_lun</span><span class="o">=</span>8,lnum_pln<span class="o">=</span>1,lsec_size<span class="o">=</span>4096,lsecs_per_pg<span class="o">=</span>4,lpgs_per_blk<span class="o">=</span>512,ldebug<span class="o">=</span>0,lstrict<span class="o">=</span>1 <span class="se">\</span>
<span class="nt">-vga</span> qxl <span class="nt">-spice</span> <span class="nv">port</span><span class="o">=</span>5930,disable-ticketing <span class="se">\</span>
<span class="nt">-net</span> user,hostfwd<span class="o">=</span>tcp::7777-:22 <span class="nt">-net</span> nic</code></pre></figure> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$spicy</span> <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 5930 <span class="c">#Connect to the guest using SPICE client</span></code></pre></figure> <ul> <li>You may have noticed that I am trying to share host’s <code class="highlighter-rouge">/home/arpith/part</code> to the guest. <br/> Once the VM boots up, mount that folder in the guest. To do so, run the following command in the guest.</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$mount</span> <span class="nt">-t</span> 9p <span class="nt">-o</span> <span class="nv">trans</span><span class="o">=</span>virtio host0 /home/arpith/part <span class="nt">-oversion</span><span class="o">=</span>9p2000.L</code></pre></figure> <ul> <li>Remember the Kernel we compiled earlier? Install it.</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$cd</span> /home/arpith/part/linux <span class="c">#Note that these commands are run in the guest OS</span>
<span class="nv">$sudo</span> dpkg <span class="nt">-i</span> linux<span class="k">*</span>4.11.0<span class="k">*</span>.deb</code></pre></figure> <p>Alternatively, you may use <code class="highlighter-rouge">-kernel</code> option to load the kernel as described <a href="http://openchannelssd.readthedocs.io/en/latest/gettingstarted/#using-qemu" target="_blank">here</a>, but I had some issues with networking and mouse pointer (which disappeared!). Hence the need for this workaround. (The issue is that the kernel does not load modules correctly when using the <code class="highlighter-rouge">-kernel</code> option. Not sure what is the cause of this issue. Maybe I’ll look into this later when I have time. A quick solution is to change certain parameters in <code class="highlighter-rouge">.config</code> from <code class="highlighter-rouge">=m</code> to <code class="highlighter-rouge">=y</code>. The driver is now built into the kernel.)</p> <ul> <li>Reboot the virtual machine. Ensure that it is running the kernel that you compiled with <code class="highlighter-rouge">uname -a</code>.</li> </ul> <h2 id="compile-and-install-nvme-cli-liblightnvm-and-pblk-tools">Compile and Install NVMe CLI, liblightnvm and pblk-tools</h2> <ul> <li>Install Nvme CLI</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$git</span> clone git@github.com:linux-nvme/nvme-cli.git
<span class="nv">$cd</span> ./nvme-cli
<span class="nv">$make</span>
<span class="nv">$sudo</span> make <span class="nb">install</span></code></pre></figure> <ul> <li>Install liblightnvm</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$git</span> clone git@github.com:OpenChannelSSD/liblightnvm.git
<span class="nv">$cd</span> ./liblightnvm
<span class="nv">$make</span>
<span class="nv">$sudo</span> make <span class="nb">install</span></code></pre></figure> <ul> <li>Install pblk-tools</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$git</span> clone git@github.com:OpenChannelSSD/pblk-tools.git
<span class="nv">$cd</span> ./pblk-tools
<span class="nv">$make</span>
<span class="nv">$sudo</span> make <span class="nb">install</span></code></pre></figure> <ul> <li>If everything went according to plan, run the following command and check if a virtual disk is detected.</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$sudo</span> nvme lnvm list</code></pre></figure> <p><a href="/assets/blog/nvme/nvme_lnvm.png"><img src="/assets/blog/nvme/nvme_lnvm.png"/></a> <br/> <br/></p> <hr/> <p><br/></p> <h2>References</h2> <ul> <li><a href="http://lightnvm.io/" target="_blank">http://lightnvm.io/</a></li> <li><a href="https://wiki.archlinux.org/index.php/QEMU#qxl" target="_blank">https://wiki.archlinux.org/index.php/QEMU#qxl</a></li> <li><a href="https://smdaudhilbe.wordpress.com/2013/04/11/how-to-install-ubuntu-inside-qemu-emulator-and-make-a-virtual-machine/" target="_blank">https://smdaudhilbe.wordpress.com/2013/04/11/how-to-install-ubuntu-inside-qemu-emulator-and-make-a-virtual-machine/</a></li> <li><a href="https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel" target="_blank">https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel</a></li> <li><a href="https://wiki.ubuntu.com/KernelTeam/GitKernelBuild" target="_blank">https://wiki.ubuntu.com/KernelTeam/GitKernelBuild</a></li> <li><a href="https://superuser.com/questions/628169/how-to-share-a-directory-with-the-host-without-networking-in-qemu" target="_blank">https://superuser.com/questions/628169/how-to-share-a-directory-with-the-host-without-networking-in-qemu</a></li> </ul> </article> <style>h2.comments{display:inline-block}.share-btn{display:inline-block;color:#b0b0b0;border:0;padding:.2em;width:1.7em;opacity:.9;outline:0;text-align:center;float:right}.share-btn:active{position:relative;top:2px;box-shadow:none;color:#b0b0b0;outline:0}.share-btn:hover{position:relative;top:-2px;box-shadow:none;color:#b0b0b0;outline:0}a.share-btn:visited{color:#b0b0b0}</style> <hr/> <br/> <h2 class="comments"> Comments </h2> <a href="javascript:;" onclick="window.print()" class="share-btn"> <i class="fa fa-print"></i> </a> <a href="https://plus.google.com/share?url=https://arpith.xyz/2017/04/guide-to-set-up-openchannel-ssd/" target="_blank" class="share-btn" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;"> <i class="fa fa-google-plus"></i> </a> <a href="http://www.facebook.com/sharer/sharer.php?u=https://arpith.xyz/2017/04/guide-to-set-up-openchannel-ssd/" target="_blank" class="share-btn" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"> <i class="fa fa-facebook"></i> </a> <a href="http://twitter.com/share?url=https://arpith.xyz/2017/04/guide-to-set-up-openchannel-ssd/&text=Guide to Setup an OpenChannel SSD using QEMU" target="_blank" class="share-btn" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fa fa-twitter"></i> </a> <div id="disqus_thread"></div> <script>var disqus_shortname="arpith",disqus_identifier="/2017/04/guide-to-set-up-openchannel-ssd/";!function(){var e=document,t=e.createElement("script");t.src="//arpith.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <style>.thumbnail img{display:none}.thumbnail:hover img{display:block;position:absolute;right:0;bottom:0}</style> <footer class="footer"> <div id="gotop">^</div> <br> <div class="thumbnail"> 2018 Arpith K<br/> Hosted on GitHub<br/> &nbsp; <img src="/images/CC-BY-SA_icon.svg"/> </div> </footer> </body> </html>